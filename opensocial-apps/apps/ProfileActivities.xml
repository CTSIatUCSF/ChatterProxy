<?xml version="1.0" encoding="UTF-8"?>
<Module>
    <ModulePrefs
            title="Activities"
            author="Alexei Vassiliev"
            author_email="alexnv@sbcglobal.net">
        <Require feature="opensocial-0.9" />
        <Require feature="views" />
        <Require feature="dynamic-height" />
        <Require feature="osapi" />
    </ModulePrefs>
    <Content type="html" view="small, canvas, default"><![CDATA[<!--HTML-->
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.js"></script>
    <script type="text/javascript" src="js/os.js" ></script>
    
	<script type="text/javascript">
		var chatterProxyURL = "http://dev-profiles.ucsf.edu/activities/ChatterProxyService.svc/activities?count="; //QA
		//var chatterProxyURL = "http://localhost:1732/ChatterProxyService.svc/activities?count=";
		var statsURL = "http://dev-profiles.ucsf.edu/qa/CustomAPI/v1/Statistics.aspx";//QA
		//var statsURL = "hhttp://dev-profiles.ucsf.edu/ucsf_100810/CustomAPI/v1/Statistics.aspx";//???
			     
		var defaultImage = '/apps/images/default_img.png';
		//var defaultImage = 'http://www.ulitochka.com/tmp/default_img.png';
	
		function loadStats() {
			$.ajax({
				type: "GET",
				url: statsURL,
				data: "{}",
				cache: false,
				contentType: "application/json; charset=utf-8",
				dataType: "json",
				success: function(msg) {
				    var stats = jQuery.parseJSON(msg);
  					$('div.stats td.profs').html(msg.profiles);
  					$('div.stats td.pubs').html(msg.publications);
				},           
				error: function(jqXHR, textStatus, errorThrown) {
					$('div.stats').html(textStatus + ", " + errorThrown);
				}
			});         
		}
		
		function loadActivities(count, callback) {
			$.ajax({
				type: "GET",
				url: chatterProxyURL + count,
				data: "{}",
				cache: false,
				contentType: "application/json; charset=utf-8",
				dataType: "json",
				success: function(msg) {
					var items = [];
					$.each(msg, function(i, item) {
					    var actHtml = buildActivityHtml(item);
    					items.push(actHtml);
  					});
  					$('div.activities').html(items.join(''));
  					
  					$('div.act-img img').error(function() {
  						$(this).unbind('error');
  						$(this).attr('src', defaultImage)
					});
					if(callback != null) {
						callback();
					}
				},           
				error: function(jqXHR, textStatus, errorThrown) { alert(errorThrown); }
			});         
		}
		
		function buildActivityHtml(item) {
		    var loc = window.top.location;
    		var path = loc.pathname.substring(0, loc.pathname.lastIndexOf('/') + 1);
			var profileUrl = path + 'ProfileDetails.aspx?Person=' + item.id;
		
			var imgUrl = '';
			if(item.id) {
				imgUrl = path + 'Thumbnail.ashx?id=' + item.id;
			}
			else {
				imgUrl = defaultImage;
			}
			
			var msg = item.m;
			var idx = msg.search(/PMID=[0-9]+/i); 
			if( idx != -1) {
			    var fr = msg.match(/PMID=[0-9]+/i);
				var pmid = fr[0].split('=')[1];
				msg = msg.substr(0,idx) + '<a href="http://www.ncbi.nlm.nih.gov/pubmed/' + pmid + '">'+ fr[0] +'</a>' + msg.substr(idx + fr[0].length);
			}
			
			return '<div class="divider">' +
				   '</div>' +
    			   '<div class="act">' +
    			   '	<div class="act-img"><img src="'+ imgUrl +'"/></div>' +
    			   '	<div class="act-body">' +
    			   '		<div class="act-user"><a href="'+profileUrl+'" target="_top">'+ item.n +'</a></div>' +
    			   '		<div class="act-msg">'+ msg +'</div>' +
    			   '	</div>' +
    			   '</div>';
		}
	</script>
    ]]></Content>
        
    <Content type="html" view="small" preferred_height="350"><![CDATA[<!--HTML-->
    <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
    
	<script type="text/javascript">	
	    gadgets.window.adjustHeight(350);	
		$(document).ready(function(){
			loadActivities(3, function(){
				var height = 0;
				$('div.act').each(function(){
					height += $(this).height();
				});
				if(height < 184) {
					$('div.activities').height(height + 66);
				    gadgets.window.adjustHeight($('act-left-view').height());	
				}
			});	            		
		    loadStats();
		    $('div.more-act a').click(function(event) {
		        event.preventDefault();
		    	gadgets.views.requestNavigateTo('canvas');	
		    });		    		   
		});			
	</script>    
    
    <!-- Styles -->
    <style type="text/css">
		body {
			margin: 0px;
		}    	
    	div.act-left-view,
    	div.act-left-view table {
    		font-size: 12px;
    	}    	
    	div.act-left-view {
			margin-right: -5px;
			width: 152px;			
    	}

    	div.stats {
    		padding-top:15px;    		
    		padding-bottom:15px;
    		margin-left:5px;
    		margin-right:5px;
    	}    	
    	
    	td.stat-val {
    		text-align: right;
    		padding-right: 5px;
    	}    	

    	div.activities {
    		overflow-y:auto;
    		height: 250px;    		    		
    	}
    	    	
    	div.act {
    		margin-left:0px;
			clear: both;    		
			min-height: 45px;			  	
    	}
    	div.act-img {
    		display:inline-block;
    		width: 45px;
    		height: 45px;
    		float:left; 		
    	}    	
    	
    	div.act-img img {
			width:100%;
			height:100%;
    	}
    	
    	div.act-body {
    		display:inline;
    	}    	
    	div.act-user{
    	}    	

    	div.act-msg, div.act-user{
    		margin-left:50px;
    		white-space:pre-wrap;
    		word-wrap:break-word;
    	}    	

    	div.divider{
    		border-top: solid 1px #CCC;
    		margin-top: 10px;
    		margin-bottom: 10px;
    		margin-left:20px;
    		margin-right:20px;
    		clear:both;
    		height:1px;
    		overflow:hidden;
    	}    	
    	    	
    	div.more-act{
    		margin-top: 15px;
    		width:100%;
    		text-align: right;
    		padding-bottom: 5px;    		 
    	}
    	div.more-act a {
    		margin-right:5px;
    	}    	
    </style>
        
    <div class="act-left-view">
    	<div class="stats">
    		<table cellspacing="0" cellpadding="0">
    			<tr><td class="stat-val profs">?</td><td class="stat-name">Total Profiles</td></tr>
    			<tr><td class="stat-val pubs">?</td><td class="stat-name">Total Publications</td></tr>
    		</table>
    	</div>
    	<div class="activities">
    		Loading...
    	</div>
    	<div class="more-act">
    		<a href="">More Activity</a>
    	</div>
    </div>]]></Content>
    <Content type="html" view="canvas" preferred_height="500"><![CDATA[<!--HTML-->
    <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
    <!--script type="text/javascript" src="http://do-web.com/js/jpaging/jquery.jpaging.0.2.js" ></script-->
	<script type="text/javascript">
	    var activities;
		$(document).ready(function(){
			loadActivities(500);	            		
		    loadStats();
		});		
	</script>    
    <style type="text/css">        
    	div.act-left-view,
    	div.act-left-view table {
    		font-size: 12px;
    	}    	
    	div.stats {
    		padding-top:15px;    		
    		padding-bottom:15px;
    		margin-left:5px;
    		margin-right:5px;
    	}    	    	
    	td.stat-val {
    		text-align: right;
    		padding-right: 5px;
    	}    	

    	div.activities {
    		overflow-y:auto;
    		height: 440px;    		    		
    	}
    	    	
    	div.act {
    		margin-left:5px;
			clear: both;  
			min-height: 45px;			  	
    	}
    	div.act-img {
    		display:inline-block;
    		width: 45px;
    		height: 45px;
    		float:left; 		
    		margin-right: 20px;
    	}
    	    	
    	div.act-img img {
			width:100%;
			height:100%;
    	}
    	
    	div.act-body {
    		padding:0px;
    		vertical-align: top;
    		display: inline;
    	}    	
    	div.act-user {
    		margin-left:0px;
    		margin-right:5px;
    		float:left;
    	}    	
    	div.act-msg {
    		margin-left:5px;
    		padding-left: 65px;
    	}

    	div.divider{
    		border-top: solid 1px #CCC;
    		margin-top: 10px;
    		margin-bottom: 10px;
    		margin-left:0px;
    		margin-right:0px;
    		clear:both;
    		height:1px;
    		overflow:hidden;
    	}    	
    	    	
    	div.more-act{
    		margin-top: 15px;
    		width:100%;
    		text-align: right;
    		padding-bottom: 5px;    		 
    	}
    	div.more-act a {
    		margin-right:5px;
    	}    	
    </style>
    
    <div class="act-left-view">
    	<div class="stats">
    		<table cellspacing="0" cellpadding="0">
    			<tr><td class="stat-val profs">?</td><td class="stat-name">Total Profiles</td></tr>
    			<tr><td class="stat-val pubs">?</td><td class="stat-name">Total Publications</td></tr>
    		</table>
    	</div>
		<div id="paging"></div>
    	<div class="activities">
    		Loading...
    	</div>
    </div>	
    ]]></Content>
</Module>