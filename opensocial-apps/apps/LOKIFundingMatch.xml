<?xml version="1.0" encoding="UTF-8"?>
<Module>
    <ModulePrefs
            title="LOKI Funding Match"
            author="Alexei Vassiliev"
            author_email="alexnv@sbcglobal.com"
            description="LOKI Funding Match">
        <Require feature="opensocial-0.9" />
        <Require feature="pubsub" />
        <Require feature="views" />
        <Require feature="osapi" />
        <Require feature="rdf" />         
    </ModulePrefs>
    <Content type="html" view="default, home, profile" preferred_height="460"><![CDATA[<!--HTML-->
    <!DOCTYPE html>
    <!--script type="text/javascript">
    	gadgets.window.adjustHeight(200);
    </script-->
    
    <!-- #includes -->
    <link rel="stylesheet" href="css/gadget.css" type="text/css" media="screen, projection">
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.js"></script>    
    <script type="text/javascript" src="js/jquery.blockUI.js"></script>    
    <script type="text/javascript" src="js/os.js" ></script>
    
    <!-- Styles -->
    <style type="text/css">
    </style>
    
    <script type="text/javascript">
	    function gadgetEventTrack(action, label, value) {
    		var message = {'action' : action};
    		if (label) {message.label = label;}
    		if (value) {message.value = value;}
    		gadgets.pubsub.publish("analytics", message);
		}
	</script>
	]]></Content>
    <Content type="html" view="profile" preferred_height="200"><![CDATA[<!--HTML-->	
	    <style type="text/css">
    	</style>
	    <script type="text/javascript">
		</script>	
		<div class="loki-profile">
			Profile page
		</div>
	]]></Content>
    <Content type="html" view="home" preferred_height="200"><![CDATA[<!--HTML-->	
	    <script type="text/javascript" src="js/UCSF.js" ></script>
    	<script type="text/javascript">
	    	function loadOwner() {
			    osapi.people.getOwner().execute(function(person) {
			    	var url = person.profileUrl;
			    	
			    	//getting owner RDF 
			    	osapi.rdf.getRDF(url).execute(function(rdf) {
			    		if(rdf.hasResearchArea) {
							for (var i = 0; i < rdf.hasResearchArea.length; i++) {
								var rdfurl = rdf.hasResearchArea[i];
								osapi.rdf.getRDF(rdfurl).execute(function(termRdf){
									if(termRdf.label) {
									 var elem = $('.loki-home input');
									 var val = elem.val();
									 if(val != '') {
									 	val += ' ';
									 } 
									 elem.val(val + termRdf.label);
									}
								});	
							}
			    		}			    		
				    });			    	 
			    });
	        };    	
	        
	        function getKeywords(){
				osapi.appdata.get({'userId': '@owner', 'groupId': '@self', 'appId':'@app', 'fields': ['loki_keywords']})
			    	.execute(function(response){
			    		var viewer = os.osapi.getViewerFromResult(response);
			    		var keywords = viewer.loki_keywords;
			    		if(keywords != null && keywords != '') {
			    			$('.loki-home input').val(keywords);
			    		}
			    		else {
			    			loadOwner();
			    		} 
			    		
			    });
			}
	        
	        
	        $(document).ready(function () {
		        $(".loki-home .save").click(function() {
		        	$(".loki-home").block({ message: "Saving..." });
	    			osapi.appdata.update({'userId': '@owner', 'groupId': '@self', 'appId':'@app', 'data':{'loki_keywords':$('.loki-home input').val()} }).execute(function(response){
	    				$(".loki-home").unblock();
	    			});		        	
		        });
		        $(".loki-home .preview").click(function() {
					var params = {};
		  			params[gadgets.io.RequestParameters.METHOD] = gadgets.io.MethodType.POST;
		  			params[gadgets.io.RequestParameters.CONTENT_TYPE] = gadgets.io.ContentType.XML;
				  	params[gadgets.io.RequestParameters.REFRESH_INTERVAL] = 0;
				  	params[gadgets.io.RequestParameters.POST_DATA] = gadgets.io.encodeValues({
				  		mode:'purpose',
		        		query: $('.loki-home input').val()
				  	});
		  		  
		  		  	$(".loki-home .content").empty();
		  		  	$(".loki-home").block({ message: "Loading, please wait..." });
  		  		    gadgets.io.makeRequest('https://www.icts.uiowa.edu/Loki/services/fundingSimilarity.jsp', function(obj) {
	  					$(".loki-home").unblock();
			  		  	if(obj.data != null) {  		  					
  		  					var matches = [];
  		  					$xml = $(obj.data);
  		  					$xml.find("foa_search_match").each(function(){
  		  						var title = $(this).find("foa_title").text();
  		  						var link = $(this).find("foa_link").text();
  		  						matches.push('<div><a target="_top" href="'+ link +'">' + title+ '</a></div>');
  		  					});
  		  					  		  					
  		  					$(".loki-home .content").append(matches.join(''));
			  			}
			  			else if(obj.errors != null) {  				
			  		  		$(".loki-home .content").text(obj.errors);
			  			}
			  		  } 
			  		  , params);		       		        
		        });
	        });
	        
    		gadgets.util.registerOnLoadHandler(getKeywords);    		
		</script>
		
	    <!-- Styles -->
	    <style type="text/css">	    	
	    	.loki-home {margin-top: 10px;}
	    	.loki-home input {width: 500px;}
	    	.loki-home .label {margin-right: 10px;font-weight: bold;}
	    	.loki-home .preview, .loki-home .save {margin-left: 10px;color: #3B6394; cursor:pointer;}	    	
	    	.loki-home .scroll-area { overflow-y: scroll; height: 150px;margin-top: 10px;}
	    	.loki-home .content {margin-left: 15px;margin-right: 15px;}
	    	.loki-home .content div {white-space:nowrap; text-overflow: ellipsis; overflow: hidden;}	    	
	    </style>
	    
		<!-- HideShow -->
		<div id="hideshow"></div>
		<!-- HideShow end -->
		<div class="loki-home">  
			<span class="label">Keywords:</span><input type="text" name="keywords"></input><span class="preview">Preview</span><span class="save">Save</span>
			<div class="scroll-area">			
				<div class="content">
				</div>		
			</div>		
		</div>
	]]></Content>
</Module>