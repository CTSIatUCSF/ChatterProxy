<?xml version="1.0" encoding="UTF-8"?>
<Module>
    <ModulePrefs
		title="People Picker" width="900">
        <Require feature="opensocial-0.9" />
        <Require feature="pubsub" />
        <Require feature="osapi" />
		<Require feature="dynamic-height" />
    </ModulePrefs>
	
    <Content type="html"><![CDATA[<!--HTML-->
    <!-- #includes -->
    <!DOCTYPE html>
	
	<style>
    	.people_picker_title {
    		font-family: Verdana, Arial;
    		font-size: 14px;
    	}
    	.people_picker_title_orange {
    		font-family: Verdana, Arial;
    		font-size: 14px;
			color: #FF9900;
    	}		
    	.people_picker_body {
    		font-family: Arial;
    		font-size: 12px;
    	}
    	.people_picker_credit {
    		font-family: Arial;
    		font-size: 10px;
    	}
    	.people_picker_table_cell {
    		font-family: Arial;
    		font-size: 12px;
			padding: 0 20px 0 0;
    	} 		   	
    </style>
	
	<!-- <div id="personids"></div> -->
	
	<div>
		<p class="people_picker_title_orange">View Picked Person List<p>
		<p class="people_picker_body">
			&nbsp;&nbsp;&nbsp;
			<a href="">Export email addresses only</a>&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp; 
			<a href="">Export all data</a>&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;
			<a href="">Delete list</a>&nbsp;&nbsp;&nbsp;<input type="button" value="show people" onClick="show_people();">
		</p>
	</div>
	
	<div id="picked_people"></div>

	<script type="text/javascript">

	function callback(sender, message) {
	
		//format of incoming id list (message):
		//{"personIds":["4570290","5113848","4872413","4591862","5542459","5222043"],"message":"210 Profiles found"}
		
		// parse the message data
		var data = gadgets.json.parse(message);
		//var appPersonIds = "test";
		//var arrPersonIds = data.personIds;
		var arrPersonIds = ["4570290","5113848","4872413","4591862","5542459","5222043"];

		//alert("personIDs to be stored: " + arrPersonIds);
		
		// store the person IDs
		osapi.appdata.update( { 'userId':'@viewer', 'appId':'@app', 'data':{'personIds':arrPersonIds} } )	
			.execute(function(result){
				//console.log(result, map);
			}
		);
	};
	
	function show_people() {
	
		// test data
		var arrPersonIds = ["4570290","5113848","4872413","4591862","5542459","5222043"];
		
		osapi.appdata.get( {'userId': '@owner', 'appId':'@app', 'fields': ['personIds']} )
			.execute(function(result){
		
			//alert("personIDs retrieved: " + JSON.stringify(result));
			
			var batch = osapi.newBatch();

			for (i in arrPersonIds) {
				batch.add('person[' + i + ']', osapi.people.get(
					{
					//'userId': data.personIds[i],
					'userId': arrPersonIds[i],
					'groupId': '@self'
					//'fields': fields
					}
				));
			}
  
			batch.execute(function(people){
		
				// make a usable json object
				var strPeople = gadgets.json.stringify(people);
				strPeople = strPeople.replace( /\]/gi, "" );
				strPeople = strPeople.replace( /\[/gi, "");
				var oPeople = gadgets.json.parse(strPeople)
		
				var strTable="<table cellspacing='0' cellpadding='0' width='600'><tr>";
			
				// build the table header row
				strTable=strTable + "<td align='left' valign='top' class='people_picker_table_cell'>"
					+ "<u><b>Last&nbsp;Name</b></u></td>";
				strTable=strTable + "<td align='left' valign='top' class='people_picker_table_cell'>"
					+ "<u><b>First&nbsp;Name</b></u></td>";
				strTable=strTable + "<td align='left' valign='top' class='people_picker_table_cell'>"
					+ "<u><b>Email&nbsp;Address</b></u></td>";
				strTable=strTable + "<td align='left' valign='top' class='people_picker_table_cell'>"
					+ "<u><b>Department</b></u></td>";
				strTable=strTable + "<td align='left' valign='top' class='people_picker_table_cell'>"
					+ "<u><b>Faculty&nbsp;Rank</b></u></td>";
				strTable=strTable + "</tr>";
		
				var table_row;
		
				// get the desired field data
				for (i in oPeople) {
					table_row="<tr>";
					table_row += "<td align='left' valign='top' class='people_picker_table_cell'>" 
						+ oPeople[i].name.familyName + "</td>";
					table_row += "<td align='left' valign='top' class='people_picker_table_cell'>" 
						+ oPeople[i].name.givenName + "</td>";
					table_row += "<td align='left' valign='top' class='people_picker_table_cell'>" 
						+ oPeople[i].emails.value + "</td>";
					table_row += "<td align='left' valign='top' class='people_picker_table_cell'>" 
						+ oPeople[i].organizations.field + "</td>";
					table_row += "<td align='left' valign='top' class='people_picker_table_cell'>" 
						+ "" + "</td>";
					table_row += "</tr>";
					strTable=strTable + table_row;
					}
		
				strTable=strTable+"</table>";

				// put the table in the people_picker div
				document.getElementById("picked_people").innerHTML = strTable;
		
				gadgets.window.adjustHeight();
			});	
		
		}); /* osapi.appdata.get */
	
	} /* show_people */

	gadgets.pubsub.subscribe("JSONPersonIds", callback);
	
	</script>
	]]>
	</Content>
</Module>
