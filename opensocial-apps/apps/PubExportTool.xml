<?xml version="1.0" encoding="UTF-8"?>
<Module>
	<ModulePrefs title="Publications Export">
		<Require feature="opensocial-0.9" />
		<Require feature="views" />
		<Require feature="dynamic-height" />
		<Require feature="pubsub" />
		<Require feature="osapi" />
	</ModulePrefs>

	<!-- ==================== START COMBINED VIEWS ==================== -->

	<Content type="html" view="canvas, small"><![CDATA[<!--HTML-->
    <!DOCTYPE html>
    
	<!-- #includes -->
	<link rel="stylesheet" href="css/gadget.css" type="text/css" media="screen, projection" >
    <script type="text/javascript" src="js/os.js" ></script>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.js"></script>    
    
	<style>
    	.tool_title {font-family:Verdana,Arial; font-size:14px;}
    	.tool_title_orange {font-family:Verdana,Arial; font-size:14px; color:#FF9900;}
    	.tool_body {font-family:Arial; font-size:12px;}
    	.tool_credit {font-family:Arial; font-size:10px;}
    	.tool_table_cell {font-family:Arial; font-size:12px; padding:0 20px 0 0;}
    	.tool_table_cell_small {font-family:Arial; font-size:11px;}
    	.tool_toggle_button {height:26px; width:70px; font-size:12px; font-weight:bold;}  		   	
    </style>

	<script type="text/javascript">
	
	//g_arrPubMedIDs = ["11110823","10516321","8929434"];
	var g_arrPubMedIDs = ["11110823"];
	var g_table_rows = "";
	var g_all_data_export = "";

	// ==============================================================

	function gadgetEventTrack(action, label, value) {
	
		var message = {'action' : action};
		if (label) {message.label = label;}
		if (value) {message.value = value;}
		
		gadgets.pubsub.publish("analytics", message);
	}	
	// ==============================================================
	
	function showHelp() {
	
		var pop = window.open('Publications Export Help','','top=200,left=200,width=450,height=275,scrollbars=0,status=0,menubar=0,location=0,resizable=0');
		pop.document.write("<html><head></head><body><div style='margin:10px; font-family:Arial; font-size:12px;'>");  
		pop.document.write("The Publications Export Tool lets you put together a list of profiles "
			+ "then export data from the list. To build the list, you can add one profile at a time, "
			+ "add a set of search results, or add a set of co-authors. You can then export "
			+ "certain data from the chosen profiles such as email addresses, names and departments."
			+ "<ul><li>Click the On/Off toggle to turn the Profile List Tool on or off.</li>"
			+ "<li>Find the profiles you want to add to your list.</li>"
			+ "<li>Click the Add link to add the currently-displayed profile(s) to your list. Only profiles that have not already been added will be counted and eligible for adding.</li>"
			+ "<li>Click the View link to see your list.</li></ul>"
			+ "From the List View you can export data from the profiles or delete the list to start over.");
		pop.document.write("<br><br><center>" 
			+ "<input type = 'button' value = 'Close' onclick = 'window.close();'>" 
			+ "</center>");
		pop.document.write("</body></html>");
	}
	// ==============================================================
	
	function initTool() {
		gadgets.pubsub.subscribe("JSONPubMedIds",processPubMedIDs);
		gadgets.window.adjustHeight(40);
	}
	// ==============================================================		
	
	function processPubMedIDs(sender, message) {
	
		// extract the array of incoming person IDs
		// g_arrPubMedIDs = gadgets.json.parse(message).PubMedIds;
	}
	// ==============================================================
	
	function buildPubList() {
	
		var table_title;
		var table_authors;
		var table_pubdate;
		var table_pmid;
		var table_row;
		var all_data_export;
		var last_names = [];
		var initials = [];
		
		g_table_rows = "";
		g_all_data_export = "";
				
		//var i = 0;		
		//while (i < g_arrPubMedIDs.length) {
			//table_authors = "";
			//table_row = "";
			//last_names = [];
			//initials = [];
		
  			$.ajax({
    			type: "GET",
    			url: "http://dev-profiles.ucsf.edu/ucsf_100810/CustomAPI/v1/PubXML.aspx?PMID=" + g_arrPubMedIDs[0],
    			dataType: "xml",
    			success: function(xml){
    				table_authors = "";
        			$(xml).find("MedlineCitation").each(function(){
            			table_title = $(this).find("ArticleTitle").text();
            			table_pubdate = $(this).find("PubDate").text();
            		
            			$(xml).find("LastName").each(function(){
            				last_names.push($(this).text());
            			});
            		
            			$(xml).find("Initials").each(function(){
            				initials.push($(this).text());
            			});
            		
            			for (i in last_names) {
            				table_authors += last_names[i] + " ";
            				table_authors += initials[i] + ". ";
            			}
            		        		
            			table_pmid = g_arrPubMedIDs[0];
            		
            			table_row = "<td width='75%' align='left' valign='top' class='tool_table_cell'>" 
							+ table_title + " " + table_authors + table_pubdate + "</td>";
						table_row += "<td width='25%; align='left' valign='top' class='tool_table_cell'>" 
							+ table_pmid + "</td>";
						g_table_rows += table_row;
						
						all_data_export = table_title + " " + table_authors + table_pubdate;
						g_all_data_export += all_data_export;	
						
						//if (i == g_arrPubMedIDs.length) {
							displayPubList();
						//}
						//i++;		
            		});
        		}
  			});
  		//} /* end while loop */
	}
	// ==============================================================	
	
	function displayPubList() {
		
		//http://dev-profiles.ucsf.edu/ucsf_100810/CustomAPI/v1/PubXML.aspx?PMID=11110823
		
		var strTable="<table cellspacing='0' cellpadding='0' width='600'>";
			
		//build the table header row
		strTable=strTable + "<td width='75%' align='left' valign='top' class='tool_table_cell'>" + "<u><b>Title</b></u><br /><br /></td>";
		strTable=strTable + "<td width='25%' align='left' valign='top' class='tool_table_cell'>" + "<u><b>PubMed&nbsp;ID</b></u><br /><br /></td>";
		strTable=strTable + "</tr>";
			
		// initialize the export divs
		document.getElementById("canvas_id_list_textarea").value = "";
		document.getElementById("canvas_full_list_textarea").value = "";

		strTable = strTable + g_table_rows;
		strTable=strTable + "</table>";
						
		// add to the id export text area
		document.getElementById("canvas_id_list_textarea").value = g_arrPubMedIDs[0];
				
		// add to the full export text area
		document.getElementById("canvas_full_list_textarea").value = g_all_data_export;
		
		document.getElementById("progress").style.display="none";
				
		// dispay the table in canvas view
		document.getElementById("canvas_pubs_list").innerHTML = strTable;
		
	} /* end viewPubList */
	
	// ==============================================================		
		
	function copyIdDivToClipboard() {
		
		document.getElementById("canvas_id_list").style.display = "block";
		document.getElementById("canvas_id_list_text").style.display = "block";
		document.getElementById("canvas_full_list").style.display = "none";
		document.getElementById("canvas_full_list_text").style.display = "none";
		document.getElementById("canvas_pubs_list").style.display = "none";	
	}
	// ==============================================================		
		
	function copyFullDivToClipboard() {
		
		document.getElementById("canvas_full_list").style.display = "block";
		document.getElementById("canvas_full_list_text").style.display = "block";
		document.getElementById("canvas_id_list").style.display = "none";
		document.getElementById("canvas_id_list_text").style.display = "none";
		document.getElementById("canvas_pubs_list").style.display = "none";
	}	
	// ==============================================================			
	
	</script>
	]]>
	</Content>

	<!-- ==================== END COMBINED VIEWS ==================== -->


	<!-- ==================== START SMALL VIEW ==================== -->

	<Content type="html" view="small"><![CDATA[<!--HTML-->
    <!DOCTYPE html>

	<div style="float:right; margin:10px 4px 0 0">
	<table cellpadding="0" cellspacing="0">
		<tr>
			<td><input id="export_button" type="button" class="tool_toggle_button" value="Export" onClick="gadgetEventTrack('click', 'export button');gadgets.views.requestNavigateTo('canvas');">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td>
			<td><img src="images/hovertiptarget.png" border="0" onClick="gadgetEventTrack('click', 'helpbutton');showHelp()"></td>
		</tr>
	</table>
	</div>

	<script type="text/javascript">
		gadgets.util.registerOnLoadHandler(initTool);
	</script>
	
	]]>
	</Content>

	<!-- ==================== END SMALL VIEW ==================== -->


	<!-- ==================== START CANVAS VIEW ==================== -->

	<Content type="html" view="canvas"><![CDATA[<!--HTML-->
    <!DOCTYPE html>
    
    <!-- top menu links -->
	<div>
		<p id="number_selected" class="tool_title_orange" style="margin-left:20px;">
		Selected Publications<p>
		<p class="tool_body" style="margin-left:20px; margin-bottom:10px;">
			<a href="javascript:gadgetEventTrack('click', 'export pubmed ids');copyFullDivToClipboard();">Export all data</a>
			&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp; 
			<a href="javascript:gadgetEventTrack('click', 'export all pubmed data');copyIdDivToClipboard();">Export IDs</a>
		</p>
		
		<p id="progress" style="margin-left:20px;">
		<br><br>
		<img src="images/waiting.gif">
		<br><br>
		<b>Processing data. This may take a minute or two, based on the size of your selected PubMed ID list.</b>
		</p>
	</div>
	
	<div id="canvas_id_list" style="display:none; background:#FFF; width:664px; height:26px; margin-left:12px;">
	Copy and paste the information below into a .txt file or another program.
	<input type="button" style="height:22px; font-size:10; margin-left:84px;" value="Close" onClick="document.getElementById('canvas_id_list').style.display='none';document.getElementById('canvas_id_list_text').style.display='none';document.getElementById('canvas_pubs_list').style.display='block';"></button>
	</div>
	
	<!-- holds the title and ID list to be copied to the clipboard -->
	<div id="canvas_id_list_text" style="display:none; width:658px; height:450px; color:#000; margin:0px 5px 0px 5px;">
	<textarea id="canvas_id_list_textarea" rows="27" cols="78" style="border:1px solid #000; margin: 0px 8px 0px 8px;">
	</textarea>
	</div>
	
	<div id="canvas_full_list" style="display:none; background:#FFF; width:664px; height:26px; margin-left: 12px;">
	Copy and paste the information below into a .txt file or another program.
	<input type="button" style="height:22px; font-size:10; margin-left:84px;" value="Close" onClick="document.getElementById('canvas_full_list').style.display='none';document.getElementById('canvas_full_list_text').style.display='none';document.getElementById('canvas_pubs_list').style.display='block';"></button>
	</div>
	
	<!-- holds the full pubs list to be copied to the clipboard -->
	<div id="canvas_full_list_text" style="display:none; width:658px; height:450px; color:#000; margin:0px 5px 0px 5px;">
	<textarea id="canvas_full_list_textarea" rows="27" cols="78" style="border:1px solid #000; margin: 0px 8px 0px 8px;">
	</textarea>
	</div>	
	
	<!-- holds the visible pub details list -->
	<div id="canvas_pubs_list" style="display:block; margin:20px 0px 0px 20px; height:525px; overflow:auto;"></div>
	
	<script type="text/javascript">
		function init() {
			gadgets.window.adjustHeight(600);
			buildPubList();
			document.getElementById("canvas_pubs_list").style.display="block";
		}
		
		init();
		
		//gadgets.util.registerOnLoadHandler(init);
	</script>
	
	]]>
	</Content>

	<!-- ==================== END CANVAS VIEW ==================== -->

</Module>