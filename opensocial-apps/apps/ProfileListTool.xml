<?xml version="1.0" encoding="UTF-8"?>
<Module>
	<ModulePrefs title="Profile List Tool">
		<Require feature="opensocial-0.9" />
		<Require feature="views" />
		<Require feature="dynamic-height" />
		<Require feature="pubsub" />
		<Require feature="osapi" />
	</ModulePrefs>
	
<!-- ==================== START COMBINED VIEWS ==================== -->   
    
    <Content type="html" view="canvas, small"><![CDATA[<!--HTML-->
    <!DOCTYPE html>
    
	<!-- #includes -->
	<link rel="stylesheet" href="css/gadget.css" type="text/css" media="screen, projection" >
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.js"></script>    
    <script type="text/javascript" src="js/os.js" ></script>
    <script type="text/javascript" src="js/UCSF.js" ></script> 
	
	<style>
    	.tool_title {font-family:Verdana,Arial; font-size:14px;}
    	.tool_title_orange {font-family:Verdana,Arial; font-size:14px; color:#FF9900;}
    	.tool_body {font-family:Arial; font-size:12px;}
    	.tool_credit {font-family:Arial; font-size:10px;}
    	.tool_table_cell {font-family:Arial; font-size:12px; padding:0 20px 0 0;}
    	.tool_table_cell_small {font-family:Arial; font-size:11px;}
    	.tool_toggle_button {height:18px; font-size:9px; font-weight:bold;}  		   	
    </style>

	<script type="text/javascript">
	
	var g_tool_state;
	var g_arrNewIDs = [];
	var g_arrOldIDs = [];
	var g_arrDeDupedIDs = [];

	// ==============================================================
	
	function showHelp() {
	
		var pop = window.open('Profile List Tool Help','','top=200,left=200,width=450,height=260,scrollbars=0,status=0,menubar=0,location=0,resizable=0');
		pop.document.write("<html><head></head><body><div style='margin:10px; font-family:Arial; font-size:12px;'>");  
		pop.document.write("The Profile List Tool lets you put together a list of profiles "
			+ "based on criteria you choose such as search results, research topics/keywords "
			+ "and/or networks. You can then export certain data from the chosen profiles "
			+ "such as names, departments, phone numbers and titles.<br>"
			+ "<ul><li>Click the On/Off toggle to turn the Profile List Tool on or off.</li>"
			+ "<li>Find the profiles you want to add to your list.</li>"
			+ "<li>Click the Add link to add the curretly-displayed profile(s) to your list.</li>"
			+ "<li>Click the View link to see your list.</li></ul>"
			+ "From the List View you can export certain data from the profiles or delete the list to start over.");
		pop.document.write("<br><br><center>" 
			+ "<input type = 'button' value = 'Close' onclick = 'window.close();'>" 
			+ "</center>");
		pop.document.write("</body></html>");
	}
	// ==============================================================
	
	function toggleToolState(obj) {
		
		if (obj.value ==  "On") {
			document.getElementById(obj.id).value = "Off";
			g_tool_state = "off";
			gadgets.window.adjustHeight(30);
			osapi.appdata.update({'userId': '@viewer', 'appId':'@app', 'data': {'on_off':'off'} }).execute(function(result) {});
			document.getElementById("actions").style.display="none";
		} else {
			document.getElementById(obj.id).value = "On";
			g_tool_state = "on";
			gadgets.window.adjustHeight(75);
			osapi.appdata.update({'userId': '@viewer', 'appId':'@app', 'data': {'on_off':'on'} }).execute(function(result) {});
			gadgets.pubsub.subscribe("JSONPersonIds", callback);			
		}
	}
	// ==============================================================
	
	function getToolState() {
	
		// fetch the on/off state
		osapi.appdata.get({'userId':'@viewer', 'appId':'@app', 'fields':['on_off']} )
			.execute(function(result){
				
			// extract and update state
			g_tool_state = os.osapi.getViewerFromResult(result).on_off;

			// update ui and pubsub
			if (g_tool_state == "on") 
				{document.getElementById("state_button").value = "On";
				gadgets.pubsub.subscribe("JSONPersonIds", callback);
			} 
			else {
				document.getElementById("state_button").value = "Off";
				document.getElementById("actions").style.display="none";
			}
				
		}); /* end osapi.appdata.get */	
	}
	// ==============================================================	
	
	function addProfilesToList() {
	
		// merge the incoming and existing person ID arrays
		var arrMergedIDs = g_arrOldIDs.concat(g_arrNewIDs);
		
		// dedupe the merged person ID array - cache it globally
		g_arrDeDupedIDs = dedupeArray(arrMergedIDs);	
	
		// store the merged deduped person IDs
		osapi.appdata.update({'userId': '@viewer', 'appId':'@app', 'data': {'pIDs': gadgets.json.stringify(g_arrDeDupedIDs)} }).execute(function(result) {});
	
		// update the UI
		document.getElementById("add_profiles").innerHTML = "Profile(s) added";
		document.getElementById("list_profiles").innerHTML = "<a style='font-size:11px;' href='javascript:gadgets.views.requestNavigateTo(\"canvas\");'>View list (" + g_arrDeDupedIDs.length + " Profiles)</a>";
	}
	
	// ==============================================================	
	
	function deleteList() {
		
		// empty the stored list
		osapi.appdata.update({'userId': '@viewer', 'appId':'@app', 'data': {'pIDs': ""} }).execute(function(result) {});
		
		document.getElementById("canvas_email_list_textarea").value = "";
		document.getElementById("canvas_full_list_textarea").value = "";
		document.getElementById("canvas_profile_list").innerHTML = "";
		document.getElementById("number_selected").innerHTML = "Select Profiles";
		
		alert("List deleted");
	}	
	
	// ==============================================================
	
	function dedupeArray(arrHasDupes) {
	
		var arrDeDuped = [];
		label:for(var i = 0; i < arrHasDupes.length;i++ ) {  
			for(var j=0; j<arrDeDuped.length;j++ ) {
				if(arrDeDuped[j] == arrHasDupes[i]) 
				continue label;
			}
			arrDeDuped[arrDeDuped.length] = arrHasDupes[i];
		}
        return arrDeDuped;
	}
	// ==============================================================	
	
	function callback(sender, message) {
	
		if (g_tool_state == "on") {	
					
			// extract the array of incoming person IDs
			var arrNewIDs = gadgets.json.parse(message);
			g_arrNewIDs = arrNewIDs.personIds;
			
			// fetch the existing person IDs
			getProfileList("small");

			// display the action item table and update it
			document.getElementById("actions").style.display="block";
			//document.getElementById("add_profiles").innerHTML = "<a style='font-size:11px;' href='javascript:addProfilesToList();'>Add " + g_arrNewIDs.length + " new Profile(s)</a>";
		}
	}
	// ==============================================================	
	
	function getProfileList(mode) {
	
		// fetch the latest person IDs
		osapi.appdata.get({'userId':'@viewer', 'appId':'@app', 'fields':['pIDs']} ).execute(function(result){
				
			// get incoming ID data (in json string format)
			var viewer = os.osapi.getViewerFromResult(result);
	
			// convert to json object format
			g_arrOldIDs = gadgets.json.parse(viewer.pIDs) || [];			
			
			// see if any incoming IDs are present in existing ID list
			for (i = 0; i < g_arrNewIDs.length; i++) {
				for (j = 0; j < g_arrOldIDs.length; j++) {
					if (g_arrOldIDs[j] == g_arrNewIDs[i]) {
						g_arrNewIDs.splice(i, 1);
					}
				}
			}
			
			if (mode == "small") {
				// update the UI
				if (g_arrNewIDs.length > 0) {
					document.getElementById("add_profiles").innerHTML = "<a style='font-size:11px;' href='javascript:addProfilesToList();'>Add " + g_arrNewIDs.length + " new Profile(s)</a>";				
				} else {
					document.getElementById("add_profiles").innerHTML = "0 new Profile(s)";
				}
				if (g_arrOldIDs.length > 0) { 
					document.getElementById("list_profiles").innerHTML = "<a style='font-size:11px;' href='javascript:gadgets.views.requestNavigateTo(\"canvas\");'>View list (" + g_arrOldIDs.length + ") Profile(s)</a>";
				} else {
					document.getElementById("list_profiles").innerHTML = "View list (0) Profile(s)";
				}
				
				gadgets.window.adjustHeight(75);
			}
			
			if (mode == "canvas") {
				// build and display the table containing the ID details
				displayProfileList();
			}
				
		}); /* end osapi.appdata.get */	
	}
	// ==============================================================		
		
	function displayProfileList() {		
		
		// set up the batch task
		var fields = [
					opensocial.Person.Field.Name, 
					opensocial.Person.Field.Emails,
					'ImageEmail',
					'imageemail',
					'email'
					];
  		var batch = osapi.newBatch();
  		
  		for (i in g_arrOldIDs) {
      		batch.add('person[' + i + ']', osapi.people.get(
				{
					'userId': g_arrOldIDs[i],
					'groupId': '@self',
					'fields': fields
				}));
  		}		
  
  		// execute the batch task
		batch.execute(function(people) {
			var strTable="<table cellspacing='0' cellpadding='0' width='600'><tr>";
			
			// build the table header row
			strTable=strTable + "<td align='left' valign='top' class='tool_table_cell'>" + "<u><b>Last&nbsp;Name</b></u></td>";
			strTable=strTable + "<td align='left' valign='top' class='tool_table_cell'>" + "<u><b>First&nbsp;Name</b></u></td>";
			strTable=strTable + "<td align='left' valign='top' class='tool_table_cell'>" + "<u><b>Email&nbsp;Address</b></u></td>";
			strTable=strTable + "<td align='left' valign='top' class='tool_table_cell'>" + "<u><b>Department</b></u></td>";
			//strTable=strTable + "<td align='left' valign='top' class='tool_table_cell'>" + "<u><b>Faculty&nbsp;Rank</b></u></td>";
			strTable=strTable + "</tr>";
		
			var table_row;
			
			// initialize the export divs
			document.getElementById("canvas_email_list_textarea").value = "";
			document.getElementById("canvas_full_list_textarea").value = "";
			
			var j = 0;
				
			for (i in people) {
			
				/* START WORKING DATA FORMAT
				{"emails":[{"value":"eric.meeks@ucsf.edu"}],
				"profileUrl":"http://dev-profiles.ucsf.edu/ucsf_100810/ProfileDetails.aspx?Person=5138614"
				"id":"5138614","thumbnailUrl":"","name":{"formatted":"Eric R. MeeksEricMeeks",
				"familyName":"Meeks","givenName":"Eric"},
				"organizations":[{"field":"Clinical & Translational Science Institute",
				"title":"Technical Lead, CTSI","name":"UCSF School of Medicine"}],
				"displayName":"Eric R. Meeks"}
				END WORKING DATA FORMAT */
			
				table_row="<tr>";
				table_row += "<td align='left' valign='top' class='tool_table_cell'>" + people[i].name.familyName + "</td>";
				table_row += "<td align='left' valign='top' class='tool_table_cell'>" + people[i].name.givenName + "</td>";
				table_row += "<td align='left' valign='top' class='tool_table_cell'>" + people[i].emails[0].value + "</td>";
				table_row += "<td align='left' valign='top' class='tool_table_cell'>" + people[i].organizations[0].field + "</td>";
				//table_row += "<td align='left' valign='top' class='tool_table_cell'>" + "" + "</td>";
				table_row += "</tr>";
				
				strTable=strTable + table_row;
				
				// add to the email export text area
				if (people[i].emails[0].value) {
					document.getElementById("canvas_email_list_textarea").value += people[i].emails[0].value + ";";
				}
				
				// add to the full export text area
				document.getElementById("canvas_full_list_textarea").value += people[i].name.familyName + ";";
				document.getElementById("canvas_full_list_textarea").value += people[i].name.givenName + ";";
				document.getElementById("canvas_full_list_textarea").value += people[i].emails[0].value + ";";
				document.getElementById("canvas_full_list_textarea").value += people[i].organizations[0].field + "\r\n";
					
				j++;
				
				// update the UI
				//document.getElementById("progress").innerHTML = "Getting details for person " + i + " of " + people.length;
			}
			
			document.getElementById("progress").style.display="none";
				
			strTable=strTable + "</table>";
			
			// dispay the table in canvas view
			document.getElementById("canvas_profile_list").innerHTML = strTable;
			document.getElementById("number_selected").innerHTML = "Selected Profiles (" + j + ")";
		});
		
	} /* end viewProfileList */
	
	// ==============================================================		
		
	function copyEmailDivToClipboard() {
		
		document.getElementById("canvas_email_list").style.display = "block";
		document.getElementById("canvas_email_list_text").style.display = "block";
	}
	// ==============================================================		
		
	function copyFullDivToClipboard() {
		
		document.getElementById("canvas_full_list").style.display = "block";
		document.getElementById("canvas_full_list_text").style.display = "block";
	}
	// ==============================================================			
	
	</script>
	]]>
	</Content>
	
<!-- ==================== END COMBINED VIEWS ==================== -->    


<!-- ==================== START SMALL VIEW ==================== -->	

    <Content type="html" view="small"><![CDATA[<!--HTML-->
    <!DOCTYPE html>
		
	<table cellspacing="6" cellpadding="5">
		<!--<tr><td colspan="3" class="tool_title"><b>My Tools</b></td></tr>-->
		<tr>
			<td class="tool_body">Profile&nbsp;List&nbsp;Tool</td>
			<td><input id="state_button" type='button' class='tool_toggle_button' value='On' onClick='toggleToolState(this)'></td>
			<td><img src="http://www.fakedoom.com/ctsi/hovertiptarget.png" border="0" onClick="showHelp()"></td>
		</tr>
	</table>

	<table id="actions" style="display:none;" cellspacing="2" cellpadding="0">
		<tr>
			<td class="tool_table_cell_small">&nbsp;>>&nbsp;</td>
			<td><span class="tool_table_cell_small" id="add_profiles">
			0 new Profile(s)</span></td>
		</tr>
		<tr>
			<td class="tool_table_cell_small">&nbsp;>>&nbsp;</td>
			<td><span class="tool_table_cell_small" id="list_profiles">
			View list (0 Profiles)</span></td>
		</tr>
	</table>
	
	<script type="text/javascript">
		getToolState();
		
		// reset to On height (75) if status is On in getToolState
		gadgets.window.adjustHeight(30);	
	</script>
	
	]]>
	</Content>

<!-- ==================== END SMALL VIEW ==================== -->


<!-- ==================== START CANVAS VIEW ==================== -->

    <Content type="html" view="canvas"><![CDATA[<!--HTML-->
    <!DOCTYPE html>
    
	<div id="canvas_email_list" style="display:none; background:#FFF; width:664px; height:26px; margin-left:12px;">
	Copy and paste the email addresses below into an Excel spreadsheet or email client "To" field.
	<!--Place your cursor anywhere in the list, right-click Select All, then Copy.-->
	<span style="float:right; padding: 0px 5px 5px 0px;">
	<input type="button" style="height:22px; font-size:10;" value="Close" onClick="document.getElementById('canvas_email_list').style.display='none';document.getElementById('canvas_email_list_text').style.display='none';"></button></span>
	</div>
	
	<!-- holds the email address list to be copied to the clipboard -->
	<div id="canvas_email_list_text" style="display:none; width:658px; height:150px; color:#000; margin:0px 5px 0px 5px;">
	<textarea id="canvas_email_list_textarea" rows="9" cols="78" style="border:1px solid #000; margin: 0px 8px 0px 8px;">
	</textarea>
	</div>
	
	<div id="canvas_full_list" style="display:none; background:#FFF; width:664px; height:26px; margin-left: 12px;">
	Copy and paste the profile data below into an Excel spreadsheet or external text editor.
	<!--Place your cursor anywhere in the list, right-click Select All, then Copy.-->
	<span style="float:right; padding: 0px 5px 5px 0px;">
	<input type="button" style="height:22px; font-size:10;" value="Close" onClick="document.getElementById('canvas_full_list').style.display='none';document.getElementById('canvas_full_list_text').style.display='none';"></button></span>
	</div>
	
	<!-- holds the full profile list to be copied to the clipboard -->
	<div id="canvas_full_list_text" style="display:none; width:658px; height:160px; color:#000; margin:0px 5px 0px 5px;">
	<textarea id="canvas_full_list_textarea" rows="9" cols="78" style="border:1px solid #000; margin: 0px 8px 0px 8px;">
	</textarea>
	</div>

    <!-- top menu links -->
	<div>
		<p id="number_selected" class="tool_title_orange" style="margin-left:20px;">
		Selected Profiles<p>
		<p class="tool_body" style="margin-left:20px; margin-bottom:10px;">
			<a href="javascript:copyEmailDivToClipboard();">Export email addresses only</a>&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp; 
			<a href="javascript:copyFullDivToClipboard();">Export all data</a>&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;
			<a href="javascript:deleteList();">Delete list</a>&nbsp;&nbsp;&nbsp;
		</p>
		
		<p id="progress" style="margin-left:20px;">
		Downloading data. This may take a minute or two, based on the size of your selected Profiles list.</p>
	</div>
	
	<!-- holds the visible profile details list -->
	<div id="canvas_profile_list" style="display:none; margin-left:20px; height:520px; overflow:auto;"></div>
	
	<script type="text/javascript">
		// update UI
		gadgets.window.adjustHeight(550);
		getProfileList("canvas");
		document.getElementById("canvas_profile_list").style.display="block";		
	</script>
	
	]]>
	</Content>	

<!-- ==================== END CANVAS VIEW ==================== -->	
	
</Module>
