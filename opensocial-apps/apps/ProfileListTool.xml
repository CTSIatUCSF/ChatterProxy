<?xml version="1.0" encoding="UTF-8"?>
<Module>
	<ModulePrefs title="ProfileListTool">
		<Require feature="opensocial-0.9" />
		<Require feature="views" />
		<Require feature="dynamic-height" />
		<Require feature="pubsub" />
		<Require feature="osapi" />
	</ModulePrefs>
	
<!-- ==================== START COMBINED VIEWS ==================== -->   
    
    <Content type="html" view="canvas, small"><![CDATA[<!--HTML-->
    <!DOCTYPE html>
    
	<!-- #includes -->
	<link rel="stylesheet" href="css/gadget.css" type="text/css" media="screen, projection" >
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.js"></script>    
    <script type="text/javascript" src="js/os.js" ></script>
    <script type="text/javascript" src="js/UCSF.js" ></script> 
	
	<style>
    	.tool_title {font-family:Verdana,Arial; font-size:14px;}
    	.tool_title_orange {font-family:Verdana,Arial; font-size:14px; color:#FF9900;}
    	.tool_body {font-family:Arial; font-size:12px;}
    	.tool_credit {font-family:Arial; font-size:10px;}
    	.tool_table_cell {font-family:Arial; font-size:12px; padding:0 20px 0 0;}
    	.tool_table_cell_small {font-family:Arial; font-size:11px;}
    	.tool_toggle_button {height:14px; font-size:10px;}  		   	
    </style>

	<script type="text/javascript">
	
	var g_tool_state = "on";
	var g_arrDeDupedIDs;
	var g_strTable
	
	// ==============================================================
	
	function toggleToolState(obj) {
		if (obj.value ==  "on") {
			document.getElementById(obj.id).value = "Off";
			g_tool_state = "off";
			return;
		} else {
			document.getElementById(obj.id).value = "On";
			g_tool_state = "on";		
		}
	}
	
	// ==============================================================	
	
	function addProfilesToList() {
		document.getElementById("add_profiles").innerHTML = "Profile(s) added";
		document.getElementById("list_profiles").innerHTML = "<a style='font-size:11px;' href='javascript:viewProfileList();'>View list (" + g_arrDeDupedIDs.length + " Profiles)</a>";
	}
	
	// ==============================================================
	
	function dedupeArray(arrHasDupes) {
		var arrDeDuped = [];
		label:for(var i = 0; i < arrHasDupes.length;i++ ) {  
			for(var j=0; j<arrDeDuped.length;j++ ) {
				if(arrDeDuped[j] == arrHasDupes[i]) 
				continue label;
			}
			arrDeDuped[arrDeDuped.length] = arrHasDupes[i];
		}
        return arrDeDuped;
	}
	
	// ==============================================================	
	
	function callback(sender, message) {
		if (g_tool_state == "on") {	
					
			// extract the array of incoming person IDs
			var arrNewIDs = gadgets.json.parse(message);
			arrNewIDs = arrNewIDs.personIds;
			
			// fetch the existing person IDs
			var result = osapi.appdata.get( {'userId': '@owner', 'appId':'@app', 'fields': ['personIds']} ).execute();
			var viewer = os.osapi.getViewerFromResult(result);
			var arrOldIDs = gadgets.json.parse(viewer.personIds) || [];
		
			// merge the incoming and existing person ID arrays
			var arrMergedIDs = arrOldIDs.concat(arrNewIDs);
		
			// dedupe the merged person ID array
			g_arrDeDupedIDs = dedupeArray(arrMergedIDs);
		
			// store the new person IDs
			//osapi.appdata.update( { 'userId':'@viewer', 'appId':'@app', 'data':{'personIds':strPersonIds} } )
				//.execute(function(result){
					//console.log(result, map);
				//}
			//);
		
			// display the action item table and update it
			document.getElementById("actions").style.display="block";
			document.getElementById("add_profiles").innerHTML = "<a style='font-size:11px;' href='javascript:addProfilesToList();'>Add " + g_arrDeDupedIDs.length + " Profile(s) to list</a>";
		}
	}
	
	// ==============================================================	
	
	function viewProfileList() {
	
		var fields = [
			opensocial.Person.Field.Name,
			opensocial.Person.Field.Emails
		];
	
  		var batch = osapi.newBatch();
  		
  		for (var i = 0; i < g_arrDeDupedIDs.length; i++) {
      		batch.add('person[' + i + ']', osapi.people.get(
				{
					'userId': g_arrDeDupedIDs[i],
					'groupId': '@self',
					'fields': fields
				}));
  		}		
  
		batch.execute(function(people) {
			var strTable="<table cellspacing='0' cellpadding='0' width='600'><tr>";
			
			// build the table header row
			strTable=strTable + "<td align='left' valign='top' class='tool_table_cell'>"
				+ "<u><b>Last&nbsp;Name</b></u></td>";
			strTable=strTable + "<td align='left' valign='top' class='tool_table_cell'>"
				+ "<u><b>First&nbsp;Name</b></u></td>";
			strTable=strTable + "<td align='left' valign='top' class='tool_table_cell'>"
				+ "<u><b>Email&nbsp;Address</b></u></td>";
			strTable=strTable + "<td align='left' valign='top' class='tool_table_cell'>"
				+ "<u><b>Department</b></u></td>";
			strTable=strTable + "<td align='left' valign='top' class='tool_table_cell'>"
				+ "<u><b>Faculty&nbsp;Rank</b></u></td>";
			strTable=strTable + "</tr>";
		
			var table_row;
		
			// get the desired field data
			for (i in people) {
				table_row="<tr>";
				
				table_row += "<td align='left' valign='top' class='tool_table_cell'>" 
					+ people[i].name.familyName + "</td>";
				table_row += "<td align='left' valign='top' class='tool_table_cell'>" 
					+ people[i].name.givenName + "</td>";
				table_row += "<td align='left' valign='top' class='tool_table_cell'>" 
					+ people[i].emails.value + "</td>";
				table_row += "<td align='left' valign='top' class='tool_table_cell'>" 
					+ people[i].organizations.field + "</td>";
				table_row += "<td align='left' valign='top' class='tool_table_cell'>" 
					+ "" + "</td>";
				table_row += "</tr>";
				
				strTable=strTable + table_row;
			}
		
			strTable=strTable+"</table>";

			// make the table available for the canvas view
			g_strTable = strTable;
		
			//gadgets.window.adjustHeight();
		});
		
		gadgets.views.requestNavigateTo("canvas");
	
	} /* viewProfileList */
	
	</script>
	]]>
	</Content>
	
<!-- ==================== END COMBINED VIEWS ==================== -->    


<!-- ==================== START SMALL VIEW ==================== -->	

    <Content type="html" view="small"><![CDATA[<!--HTML-->
    <!DOCTYPE html>
		
	<table cellspacing="8" cellpadding="5">
		<tr><td colspan="3" class="tool_title"><b>My Tools</b></td></tr>	
		<tr>
			<td class="tool_body">Profile&nbsp;List&nbsp;Tool</td>
			<td><input id="state_button" type='button' class='tool_toggle_button' value='On' onClick='toggleToolState(this)'></td>
			<td><img src="http://www.fakedoom.com/ctsi/hovertiptarget.png" border="0"></td>
		</tr>
	</table>

	<table id="actions" style="display:none;" cellspacing="2" cellpadding="0">
		<tr>
			<td class="tool_table_cell_small">&nbsp;>>&nbsp;</td>
			<td><span class="tool_table_cell_small" id="add_profiles"><a href="#">Add 0 Profiles to List</span></a></td>
		</tr>
		<tr>
			<td class="tool_table_cell_small">&nbsp;>>&nbsp;</td>
			<td><a href="#"><span class="tool_table_cell_small" id="list_profiles">View list (0 Profiles)</a></span></td>
		</tr>
	</table>
	
	<script type="text/javascript">	
		gadgets.pubsub.subscribe("JSONPersonIds", callback);
	</script>
	
	]]>
	</Content>

<!-- ==================== END SMALL VIEW ==================== -->


<!-- ==================== START CANVAS VIEW ==================== -->

    <Content type="html" view="canvas"><![CDATA[<!--HTML-->
    <!DOCTYPE html>	
	
	<div>
		<p class="tool_title_orange">View Picked Person List<p>
		<p class="tool_body">
			&nbsp;&nbsp;&nbsp;
			<a href="">Export email addresses only</a>&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp; 
			<a href="">Export all data</a>&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;
			<a href="">Delete list</a>&nbsp;&nbsp;&nbsp;
		</p>
	</div>
	
	<div id="canvas_profile_list"></div>
	
	<script type="text/javascript">	
		document.getElementById("canvas_profile_list").innerHTML = g_strTable;
	</script>
	
	]]>
	</Content>	

<!-- ==================== END CANVAS VIEW ==================== -->	
	
</Module>
