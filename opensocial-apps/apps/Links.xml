<?xml version="1.0" encoding="UTF-8"?>
<Module>
    <ModulePrefs
        title="Websites">
        <Require feature="views" />
        <Require feature="dynamic-height" />
        <Require feature="pubsub" />
        <Require feature="osapi" />
    </ModulePrefs>

<!-- ==================== START COMBINED VIEWS ==================== -->    
    
    <Content type="html" view="home, profile"><![CDATA[<!--HTML-->
    <!DOCTYPE html>
    
	<!-- #includes -->
	<link rel="stylesheet" href="css/gadget.css" type="text/css" media="screen, projection" >
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.js"></script>    
    <script type="text/javascript" src="js/os.js" ></script>
    <script type="text/javascript" src="js/UCSF.js" ></script>
    
	<style>
    	.links_title {font-family:Verdana, Arial; font-size: 14px;}
    	.links_body {font-family:Arial; font-size: 12px; }
    	.links_credit { font-family:Arial; font-size:10px; }      	
    </style>
	
	<script type="text/javascript">
	
    	var g_max_links = 5;
    	var g_total_links;
    	var links = "";
		var links_array = "";	
	
		function deleteArrayItem (array_index) {
			links = links.replace(links_array[array_index]+"|", "");	
			osapi.appdata.update({'userId':'@viewer', 'appId':'@app', 'data':{'links':links} }).execute(function(result){});
			links="";

			// special dev routine to delete all links data		
			//osapi.appdata.update({'userId': '@viewer', 'appId':'@app', 'data':{'links':links} }).execute(function(result){});
			//alert("All app data deleted");
		
			displayLinksAppData();
		}
	
		function displayLinksAppData() {
			osapi.appdata.get( {'userId': '@owner', 'appId':'@app', 'fields': ['links'] } )
				.execute(function(result){
				
					// trim fetched app data to pure delimited string
					var fetched_appdata_string = JSON.stringify(result);
					var fetched_appdata_array = fetched_appdata_string.split("links\":\"");
					fetched_appdata_string = fetched_appdata_array[1];
					fetched_appdata_array = fetched_appdata_string.split("\"}}");
					links = links + fetched_appdata_array[0];
					
					// convert delimited string to array
					links_array = links.split("|");
					
					// sort the array alphbetically based on link name
					// case-sensitive sort 
					// links_array.sort();
					
					// custom case-insensitive sort
					links_array.sort(function(x,y){ 
						var a = String(x).toUpperCase(); 
						var b = String(y).toUpperCase(); 
						if (a > b) {return 1;}
						if (a < b) {return -1;} 
						return 0; 
					}); 
                    
                    // EDIT MODE - build table to hold retrieved app data
                    var links_table_data = "<table cellspacing='10' cellpadding='0' border='0'><tr>";
					var links_item_array;
					var favicon_path_array;
					
					g_total_links = links_array.length - 1;
					if (g_total_links < 0) {g_total_links = 0;}
                    
					for(i = 0; i < links_array.length; i++){
						link_item = links_array[i];
						
						// if link item is presentable
						if(link_item.indexOf("^") != -1) {
							link_item_array = link_item.split("^");
							cell_name=link_item_array[0];
							cell_url=link_item_array[1];
							cell_url2=link_item_array[1];
							
							favicon_path_array = cell_url.split("//");
							cell_url2 = favicon_path_array[1];
							favicon_path_array = cell_url2.split("/");
							cell_url2 = favicon_path_array[0];
							cell_favicon="<img height='16' width=16' src='http://www.google.com/s2/favicons?domain=" + cell_url2 + "' />";
                            
							// build and add table row
							links_table_data = links_table_data
							+ "<tr>" + "<td>" + cell_favicon + "</td>"
							+ "<td>" + "<a href='" + cell_url + "' target='_blank'>" + cell_name + "</a></td>"
							+ "<td>" + cell_url + "</td>"
							+ "<td><input type='button' class='link_save' value='Delete' onClick='deleteArrayItem(" 
							+ i + ")'" + "></td>" + "</tr>";
						}
					}
                    
                    // close the table
                    links_table_data = links_table_data + "</tr></table>";
                        
                    // put appdata table markup in designated div
                    // and set height based on which view view this is
					if (document.getElementById("edit_links_table")){
						document.getElementById("edit_links_table").innerHTML=links_table_data;
						edit_mode_height = 250 + ((links_array.length - 1) * 28) + 10;
						//alert("number of links: " + links_array.length);
						//alert("set height to: " + edit_mode_height);						
						gadgets.window.adjustHeight(edit_mode_height);
					}
					
                    // VIEW MODE - build table to hold retrieved app data
					links_table_data = "<table cellspacing='10' cellpadding='0' border='0'><tr>";
                    
					for(i = 0; i < links_array.length; i++){
						link_item = links_array[i];
						if(link_item.indexOf("^") != -1) {
							link_item_array = link_item.split("^");
							cell_name=link_item_array[0];
							cell_url=link_item_array[1];
							cell_url2=link_item_array[1];
							
							favicon_path_array = cell_url.split("//");
							cell_url2 = favicon_path_array[1];
							favicon_path_array = cell_url2.split("/");
							cell_url2 = favicon_path_array[0];
							cell_favicon="<img height='16' width=16' src='http://www.google.com/s2/favicons?domain=" + cell_url2 + "' />";

							// build and add table row
							links_table_data = links_table_data
							+ "<tr>"
							+ "<td>" + cell_favicon + "</td>"
							+ "<td>" + "<a href='" + cell_url + "' target='_blank'>" + cell_name + "</a></td>"
							+ "</tr>";
						}
					}
                    
                    // close the table
                    links_table_data = links_table_data + "</tr></table>";
                        
                    // put appdata table markup in designated div
					if(document.getElementById("view_links_table")){
						document.getElementById("view_links_table").innerHTML=links_table_data;
						view_mode_height = 12 + ((links_array.length - 1) * 28) + 24;
						//alert("number of links: " + links_array.length);
						//alert("set height to: " + view_mode_height);
						gadgets.window.adjustHeight(view_mode_height);					
					}
					
					if(document.getElementById("linkurl")){
						document.getElementById("linkurl").value = "http://";
					}					
			}); /*osapi.appdata.get*/
		}
		
		function saveLinksAppData() {
	
			if (g_total_links < g_max_links) {
				
				// get link name and url from form
                var new_link_name=document.getElementById("linkname").value;
                var new_link_url=document.getElementById("linkurl").value;
				
				// check for empty input boxes
				if(new_link_name=="" || new_link_url==""){
					alert("Please provide both a Link Name and a URL");
					return;
				}
				
				// prepend http header if missing
				if(new_link_url.indexOf("://") == -1){new_link_url = "http://" + new_link_url;}
				
				// remove delimiter chars in case any were keyed in
				new_link_name = new_link_name.replace("|", "");
				new_link_name = new_link_name.replace("^", "");
				new_link_url = new_link_url.replace("|", "");
				new_link_url = new_link_url.replace("^", "");				
				
				// build link item, combine current list with new item, write and clear list
				var link_data = new_link_name + "^" + new_link_url + "|";
				links = links + link_data;
                osapi.appdata.update({'userId': '@viewer', 'appId':'@app', 'data':{'links':links} }).execute(function(result) {});   
                links = "";        
                        
                // refresh after update, clear input fields
                displayLinksAppData();
				document.getElementById("linkname").value = "";
                document.getElementById("linkurl").value = "";
				
				alert("Your links information is saved. Don't forget to use the Hide / Show links to make this section visible or hidden on your profile page.");
			} else {alert("You already have the maximum number of links.");}
        }
        		
	</script>
    
    ]]></Content>
<!-- ==================== END COMBINED VIEWS ==================== -->   

<!-- ==================== START HOME/EDIT VIEW ==================== -->
    <Content type="html" view="default, home" preferred_height="300"><![CDATA[<!--HTML-->
    	
    <script type="text/javascript">displayLinksAppData();</script>    	
    
	<div id="hideshow" style="padding:5px 10px 0px 0px;"></div>
	
    <h3 style="padding-left:10px; padding-top: 0px;">Manage Links to Other Websites</h3>

    <div style="padding:5px 0px 0px 25px;">
    	Add up to five  websites to your profile. 
		Enter the website name, as you want it to appear on your profile, and its URL. 
        Some samples include a link to your lab web site, your research program or your research blog.<br /><br />
	</div>
	
	<!-- display the new link input fields -->
	<div class='question' style="padding:0px 0px 5px 12px;">
		<table cellpadding="0" cellspacing="0">
			<tr>
				<td class="links_body" valign="top"><b>Website Name</b><br />
					e.g. My Lab Site<br />
                    <input id="linkname" type="linkname" name="linkname" style="width:280px; margin-top:4px;"><br />
                    (60 characters max)
                </td>
				<td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td>
				<td class="links_body" valign="top"><b>Website URL</b> (not displayed in profile)<br />
					e.g. mylabsite.ucsf.edu<br />
                    <input id="linkurl" type="linkurl" name="linkurl" style="width:250px; margin-top:4px;" value="http://">
                </td>
                <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td>
                <td><br /><br /><input type="button" style="margin-bottom: 8px;" value="Save" onClick="saveLinksAppData();"></td>
			</tr>				
		</table>			
	</div>
    
    <h4 style="padding-left:10px; padding-top: 0px;">Your Current Websites:</h4>
    <div id="edit_links_table" style="padding:0px 0px 10px 25px;"></div>
            
    ]]></Content>
<!-- ==================== END HOME/EDIT VIEW ==================== -->    
    
<!-- ==================== START PROFILE VIEW ==================== -->
    <Content type="html" view="default, profile" preferred_height="100"><![CDATA[<!--HTML-->
    
    <script type="text/javascript">displayLinksAppData();</script>
    <div id="view_links_table" style="padding:0px 0px 10px 20px;"></div>
    
    ]]></Content>
<!-- ==================== END PROFILE VIEW ==================== -->  

</Module>
