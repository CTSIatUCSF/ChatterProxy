<?xml version="1.0" encoding="UTF-8"?>
<Module>
    <ModulePrefs
            title="Hello Mentor!" height="800">
        <Require feature="opensocial-0.8" />
        <Require feature="settitle" />
        <Require feature="dynamic-height" />
    </ModulePrefs>
    <Content type="html"><![CDATA[<script type="text/javascript">
		gadgets.window.setTitle('Mentor Gadget3');
        var globalOwner = {};
      
        function loadPeople() {
          var req = opensocial.newDataRequest();
  	      req.add(req.newFetchPersonRequest('OWNER'), 'owner');
          req.add(req.newFetchPersonAppDataRequest(opensocial.newIdSpec({'userId': 'OWNER'}), 'MENTOR_STATUS'), 'mentor_status');
  	      req.add(req.newFetchPersonRequest('VIEWER'), 'viewer');
          req.send(onLoadPeople);
        }

        function onLoadPeople(data) {
          globalOwner = data.get('owner').getData();
          var mentorStatus = data.get('mentor_status');          
          var viewer = data.get('viewer').getData();
          
          html = new Array();
          html.push('<ul>');
          html.push('<li>You are ' + viewer.getDisplayName() + '</li>');
          html.push('<li>You are looking at ' + globalOwner.getDisplayName() + '</li>');
          html.push('</ul>');
          document.getElementById('people').innerHTML = html.join('');

          if (!mentorStatus.hadError()) {
          	  var ownerId = globalOwner.getId();
              var mentorStatusText = mentorStatus.getData()[ownerId]['MENTOR_STATUS'];
              showMentorStatus(mentorStatusText);

	          // create form if owner = viewer
	          if (globalOwner.getId() == viewer.getId()) {
	          	 document.getElementById('mentor').innerHTML = 
	          	 	"<form id='mentor_form'><INPUT name='mentorStatus' type='checkbox' value='' onclick='setMentorStatus();'>Click the box to change your status</form>";
	          if (mentorStatusText == "Yes")	          
				 	document.getElementById('mentor_form').mentorStatus.checked = 1; 
	          }         
          }
          else {
                document.getElementById("status_msg").innerHTML = data.getErrorMessage();
          }
        }

        function init() {
          loadPeople();
        }
        
        function setMentorStatus() {
            var mentorStatus = "";
        	if (document.getElementById('mentor_form').mentorStatus.checked) 
        		mentorStatus = "Yes";
            else
            	mentorStatus = "No";

            var req = opensocial.newDataRequest();
            req.add(req.newUpdatePersonAppDataRequest('VIEWER', "MENTOR_STATUS", mentorStatus));
            req.send(onPersistStatus);
			showMentorStatus(mentorStatus);
        } 
        
        function showMentorStatus(mentorStatus) {
        	if (mentorStatus == "Yes") {
		          document.getElementById('status').innerHTML = globalOwner.getDisplayName() + ' is a mentor&nbsp<img src="http://dev-profiles.ucsf.edu/shindig/yoda.jpg"/>';//html.join('');
        	}
        	else {
		          document.getElementById('status').innerHTML = globalOwner.getDisplayName() + ' is not a mentor';
        	}
//            gadgets.window.adjustHeight();                  
        }
        
        function onPersistStatus(data) {
            if (data.hadError()) { 
                document.getElementById("status_msg").innerHTML = data.getErrorMessage();
            }
            else {
                document.getElementById("status_msg").innerHTML = "Success! Your profile was updated successfully!";    
            }
        }    
        
        gadgets.util.registerOnLoadHandler(init);
      </script>
      <div id='main'>
        <div id='people'></div>
        <div id='mentor'></div>
        <div id='status'></div>
        <div id='status_msg'></div>        
      </div>]]></Content>
</Module>